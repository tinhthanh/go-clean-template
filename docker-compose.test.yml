# Docker Compose for running ALL tests (unit + integration) inside Docker.
# Usage: docker compose -f docker-compose.test.yml up --build --abort-on-container-exit
services:
  test-db:
    image: postgres:18.2-alpine
    environment:
      POSTGRES_USER: testuser
      POSTGRES_PASSWORD: testpass
      POSTGRES_DB: testdb
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U testuser -d testdb"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s

  test-redis:
    image: redis:7.4-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s

  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.test
    environment:
      # Integration test connections (override testcontainers with real services).
      TEST_PG_URL: "postgres://testuser:testpass@test-db:5432/testdb?sslmode=disable"
      TEST_REDIS_URL: "redis://test-redis:6379/0"
      # App config for any config-dependent tests.
      APP_NAME: "go-clean-template-test"
      APP_VERSION: "1.0.0"
      APP_ENV: "test"
      HTTP_PORT: "8080"
      LOG_LEVEL: "error"
      PG_POOL_MAX: "2"
      PG_URL: "postgres://testuser:testpass@test-db:5432/testdb?sslmode=disable"
      GRPC_ENABLED: "false"
      RMQ_ENABLED: "false"
      NATS_ENABLED: "false"
      REDIS_ENABLED: "false"
      TRACER_ENABLED: "false"
      METRICS_ENABLED: "false"
      SWAGGER_ENABLED: "false"
    depends_on:
      test-db:
        condition: service_healthy
      test-redis:
        condition: service_healthy
